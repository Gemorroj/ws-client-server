#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

use Amp\Websocket;
use WsClientServer\Emitter;
use Amp\Websocket\Handshake;

echo '[' . \date(\DATE_ATOM) . ']: Emitter started.' . "\n";
\register_shutdown_function(function() {
    echo '[' . \date(\DATE_ATOM) . ']: Emitter shutdown.' . "\n";
});

Amp\Loop::run(function () {
    $handshake = new Handshake('ws://localhost:8080/pusher');
    $handshake->addHeader('User-Agent', 'Ws-Emitter/0.1');

    /** @var \Amp\Websocket\Connection $connection */
    $connection = yield Websocket\connect($handshake);
    echo 'Connected to websocket server' . "\n";

    $emitter = new Emitter($connection);
    yield from $emitter->run();
});
